---
title: "ENSAB"
author: "Maria Camila Restrepo"
date: "2025-02-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ENSAB databases

```{r}
library(here)
library(readr)
library(tidyverse)
if(!require(MASS)) install.packages("MASS")
library(MASS)
if(!require(survey)) install.packages("survey")
library(survey)

ninoscompleta <- read_delim(
  here("ensab", "M3_NINOS.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

examen13completa <- read_delim(
  here("ensab", "M4_EXAMEN_1.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

examen5completa <- read_delim(
  here("ensab", "M4_EXAMEN_2.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

hogarcompleta <- read_delim(
  here("ensab", "M1_HOGAR.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

```

We have a total of 6446 children for the sample size

```{r}
glimpse(ninoscompleta)
summary(ninoscompleta$Estrato)
names(ninoscompleta)
```

Keep variables:

- MPIO
- DPTO
- M3_100C: age
- M3_113D: grupo etnico
- M3_113F: maximo nivel educativo alcanzado por el ppal responsable economico
- M3_119: ingresos mensuales ppal responsable economico
- M3_201: Where does the child spend most of their time
- M3_202: With whom does the child spend most of their time
- M3_224: Lactancia materna edad
- M3_225: Biberon
- M3_226: Biberon edad
- M3_227: Que le dan en el biberon. 227A-227CU
- M3_229: Nutrition
- Grandesciudades: DANE big city identificator
- Region: a donde pertenece el municipio
- Subreg:
- Municipio:
- Fex_fin: factor de expansion final
- Sexo
- Zona: urbana, rural
- EST_SE_2: Nivel socioeconomico
- FRACCION: fraccion social
- REGIMEN: contributivo, subsidiado, especial, no asegurado
- ID_HOGAR
- ID_PERSONA

Grupo etareo was excluded because it is the same as age.

```{r}
ninos <- ninoscompleta %>% 
  dplyr::select(ÿDANE, MPIO, DPTO, M3_100C, M3_113D, M3_113E, M3_113F, M3_119, M3_201, M3_202, M3_205, M3_213, M3_226, M3_206A, M3_224, M3_225, M3_206B, M3_227, M3_227A, M3_227B, M3_227C, M3_227D, M3_227E, M3_227F, M3_227G, M3_227CU, M3_229AA, M3_229AB, M3_229BA, M3_229BB, M3_229CA, M3_229CB, M3_229DA, M3_229DB, M3_229EA, M3_229EB, M3_229FA, M3_229FB, M3_229GA, M3_229GB, M3_229HA, M3_229HB, M3_229IA, M3_229IB, Region, Subreg, Municipio, Fex_fin, Sexo, Zona, EST_SE_2, FRACCION, REGIMEN, ID_HOGAR, ID_PERSONA, Grandesciudades)

glimpse(ninos)

ninoscompleta %>%
  group_by(MPIO) %>%
  summarise(unique_DANE = n_distinct(ÿDANE)) %>%
  arrange(desc(unique_DANE))

#We can see there are some municipalities by the same name, so it is better to use the unique identifier from the census. 

ninos <- ninos %>%
  rename(census_mpio = ÿDANE)
```

Hogar has the same basic variables, so we wont join it for now.

Exploring hogar:

```{r}
#Ethnicity

hogarcompleta %>%
  group_by(M1_303D) %>%
  count()

#14238 NAs. Won't use it
```

# Explorative data analysis

Steps of explorative data analysis:
1. Explore each variable, look at the data
2. Explore the distribution of each variable
3. Look at the relationships between variables
5. Explore the amount of missing data and make decisions for dropping the variable, observations or imputing
6. Final analytical data set for bivariate associations and multivariable associations

## Main outcome: caries experience and severity

Caries:

DMFT: decayed, missing and filled teeth

Questions 305 and 307

0: A Sano, F sellante, 
1: B Cavitaded, C: filling with caries, D: filled without caries, E: missing due to caries, G: Protesis, corona, retenedor, carilla
H: no registra (ausente o sin erupcionar)

MA_305A, MA_305B, MA_305C, MA_305D, MA_305E, MA_305F, MA_305G, MA_305H, MA_305I, MA_305J
MA_307A, MA_307B, MA_307C, MA_307D, MA_307E, MA_307F, MA_307G, MA_307H, MA_307I, MA_307J

MB_208: Aplicación del examen clínico (dependiendo de 
antecedentes médicos). 1: se aplica el examen. 2: no se aplica el examen.

### Children 1 and 3 years old

Select variables:

304: ICDAS 55-65
306: ICDAS 85-75
305: cop 55-65
307: cop 85-75

Ommit variables ending in 1 because they refer to enamel opacities (non-carious).

```{r}
examen13 <- examen13completa %>%
  dplyr::select(MA_201B, MA_208, MA_304A, MA_304B, MA_304C, MA_304D, MA_304E, MA_304F, MA_304G, MA_304H, MA_304I, MA_304J, MA_306A, MA_306B, MA_306C, MA_306D, MA_306E, MA_306F, MA_306G, MA_306H, MA_306I, MA_306J, MA_305A, MA_305B, MA_305C, MA_305D, MA_305E, MA_305F, MA_305G, MA_305H, MA_305I, MA_305J, MA_307A, MA_307B, MA_307C, MA_307D, MA_307E, MA_307F, MA_307G, MA_307H, MA_307I, MA_307J, ID_HOGAR, ID_PERSONA) %>%
  mutate(ICDAS55 = MA_304A,
         ICDAS54 = MA_304B,
         ICDAS53 = MA_304C,
         ICDAS52 = MA_304D,
         ICDAS51 = MA_304E,
         ICDAS61 = MA_304F,
         ICDAS62 = MA_304G,
         ICDAS63 = MA_304H,
         ICDAS64 = MA_304I,
         ICDAS65 = MA_304J,
         ICDAS85 = MA_306A,
         ICDAS84 = MA_306B,
         ICDAS83 = MA_306C,
         ICDAS82 = MA_306D,
         ICDAS81 = MA_306E,
         ICDAS71 = MA_306F,
         ICDAS72 = MA_306G,
         ICDAS73 = MA_306H,
         ICDAS74 = MA_306I,
         ICDAS75 = MA_306J,
         COP55 = MA_305A,
         COP54 = MA_305B,
         COP53 = MA_305C,
         COP52 = MA_305D,
         COP51 = MA_305E,
         COP61 = MA_305F,
         COP62 = MA_305G,
         COP63 = MA_305H,
         COP64 = MA_305I,
         COP65 = MA_305J,
         COP85 = MA_307A,
         COP84 = MA_307B,
         COP83 = MA_307C,
         COP82 = MA_307D,
         COP81 = MA_307E,
         COP71 = MA_307F,
         COP72 = MA_307G,
         COP73 = MA_307H,
         COP74 = MA_307I,
         COP75 = MA_307J)
```

Caries experience: with ICDAS

Experiencia modificada: includes cavitaded and non-cavitaded carious lesions.

304: ICDAS 55-65
306: ICDAS 85-75

Caries if:
* 2: first/distinct visual change in enamel (ICDAS 1 and 2)
* 3: Localized enamel breakdown (considered cavitated) (ICDAS 3)
* 4: underlying dark shadow from dentin without enamel breakdown (ICDAS 4)
* 5: distinc cavity with visible dentin (ICDAS 5)
* 6: extensive cavity with visible dentin (ICDAS 6)

2 is non-cavitated, 3-6 are cavitated.

Not caries if:
0 or 9

New categorization:
* No caries: 0 if 0 or 9
* Non-cavitated: 1 if 2
* Cavitated: 2 if 3, 4, 5 or 6

dmft including non-cavitated lessions

```{r}
#Assign a value to 1 to the following numbers: 2, 3, 4, 5, 6

head(examen13$ICDAS55, 20)
examen13 <- examen13 %>%
  mutate(
    across(
      starts_with("ICDAS"),
      ~case_when(
        str_detect(., "^[23456]$") ~ 1,
        TRUE ~ 0)
    ))
head(examen13$ICDAS55, 20)
```

dmft: cavitated and non-cavitated

Only count missing and filled, decayed is being counted with ICDAS classification.

1 if: C (filled with caries), D (filled without caries), E (missing due to caries), G (prosthesis, crown, retainer, veneer)
0 if: A (healthy), F (sealant), H (not registered), B (cavitated)

```{r}
#Assign a value of 1 to the following letters:

head(examen13$COP51, 50)
examen13 <- examen13 %>%
  mutate(
    across(
      starts_with("COP"),
      ~case_when(
        str_detect(., "[CDEG]") ~ 1,
        TRUE ~ 0)
    ))
head(examen13$COP51, 50)

#Create variable dmft_ICDAS that includes the sum of both ICDAS and COP variables

#first: create dummy variable for each tooth that assings 1 if either ICDAS or COP is greater than 0, 0 otherwise. For example, if ICDAS51 is 1, then dmft51 = 1. If COP51 is 1, then dmft51 = 1. If both are 1, then dmft51 = 1. If both are 0, then dmft51 = 0.

examen13 <- examen13 %>%
  mutate(score55 = case_when(
    ICDAS55 > 0 | COP55 > 0 ~ 1, TRUE ~ 0),
    score54 = case_when(
    ICDAS54 > 0 | COP54 > 0 ~ 1, TRUE ~ 0),
    score53 = case_when(
    ICDAS53 > 0 | COP53 > 0 ~ 1, TRUE ~ 0),
    score52 = case_when(
    ICDAS52 > 0 | COP52 > 0 ~ 1, TRUE ~ 0),
    score51 = case_when(
    ICDAS51 > 0 | COP51 > 0 ~ 1, TRUE ~ 0),
    score61 = case_when(
    ICDAS61 > 0 | COP61 > 0 ~ 1, TRUE ~ 0),
    score62 = case_when(
    ICDAS62 > 0 | COP62 > 0 ~ 1, TRUE ~ 0),
    score63 = case_when(
    ICDAS63 > 0 | COP63 > 0 ~ 1, TRUE ~ 0),
    score64 = case_when(
    ICDAS64 > 0 | COP64 > 0 ~ 1, TRUE ~ 0),
    score65 = case_when(
    ICDAS65 > 0 | COP65 > 0 ~ 1, TRUE ~ 0),
    score85 = case_when(
    ICDAS85 > 0 | COP85 > 0 ~ 1, TRUE ~ 0),
    score84 = case_when(
    ICDAS84 > 0 | COP84 > 0 ~ 1, TRUE ~ 0),
    score83 = case_when(
    ICDAS83 > 0 | COP83 > 0 ~ 1, TRUE ~ 0),
    score82 = case_when(
    ICDAS82 > 0 | COP82 > 0 ~ 1, TRUE ~ 0),
    score81 = case_when(
    ICDAS81 > 0 | COP81 > 0 ~ 1, TRUE ~ 0),
    score71 = case_when(
    ICDAS71 > 0 | COP71 > 0 ~ 1, TRUE ~ 0),
    score72 = case_when(
    ICDAS72 > 0 | COP72 > 0 ~ 1, TRUE ~ 0),
    score73 = case_when(
    ICDAS73 > 0 | COP73 > 0 ~ 1, TRUE ~ 0),
    score74 = case_when(
    ICDAS74 > 0 | COP74 > 0 ~ 1, TRUE ~ 0),
    score75 = case_when(
    ICDAS75 > 0 | COP75 > 0 ~ 1, TRUE ~ 0))

#sum the dummy variables
examen13 <- examen13 %>%
  mutate(dmft_ICDAS = rowSums(across(starts_with("score"), ~. > 0)))

summary(examen13$dmft_ICDAS) #now the max is 20

#See distribution

ggplot(data = examen13, aes(x = dmft_ICDAS)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score for 1 and 3 years old")
```

Caries experience based on dmft_ICDAS

```{r}
examen13 <- examen13 %>%
  mutate(cariesexp = case_when(
    dmft_ICDAS > 0 ~ 1,
    TRUE ~ 0
  )) %>%
  mutate(cariesexp = factor(cariesexp, levels = c(0, 1), labels = c("No caries", "Caries")))

summary(examen13$cariesexp)
```

dmft(copd)

```{r}
#Assign a value to 1 to the following letters: B, C, D, E, G
examen13 <- examen13 %>%
  mutate(
    across(
      starts_with("MA_3"),
      ~case_when(
        str_detect(., "[BCDEG]") ~ 1,
        TRUE ~ 0)
    ))

#create variable dmft
examen13 <- examen13 %>%
  mutate(dmft = rowSums(across(starts_with("MA_3"), ~. > 0))) %>%
  dplyr::select(-starts_with("MA_3"))

glimpse(examen13)
summary(examen13$dmft)

#See distribution
ggplot(data = examen13, aes(x = dmft)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score for 1 and 3 years old")
```

### Children 5 years old

Select variables (like 1y old)
Exclude 1M from the analysis (because the outcome is ECC). Letters A and L.

```{r}
examen5 <- examen5completa %>% 
  dplyr::select(MB_201B, MB_208, MB_304B, MB_304C, MB_304D, MB_304E, MB_304F, MB_304G, MB_304H, MB_304I, MB_304J, MB_304K, MB_306B, MB_306C, MB_306D, MB_306E, MB_306F, MB_306G, MB_306H, MB_306I, MB_306J, MB_306K, MB_305B, MB_305C, MB_305D, MB_305E, MB_305F, MB_305G, MB_305H, MB_305I, MB_305J, MB_305K, MB_307B, MB_307C, MB_307D, MB_307E, MB_307F, MB_307G, MB_307H, MB_307I, MB_307J, MB_307K, ID_HOGAR, ID_PERSONA) %>%
  mutate(ICDAS55 = MB_304B,
         ICDAS54 = MB_304C,
         ICDAS53 = MB_304D,
         ICDAS52 = MB_304E,
         ICDAS51 = MB_304F,
         ICDAS61 = MB_304G,
         ICDAS62 = MB_304H,
         ICDAS63 = MB_304I,
         ICDAS64 = MB_304J,
         ICDAS65 = MB_304K,
         ICDAS85 = MB_306B,
         ICDAS84 = MB_306C,
         ICDAS83 = MB_306D,
         ICDAS82 = MB_306E,
         ICDAS81 = MB_306F,
         ICDAS71 = MB_306G,
         ICDAS72 = MB_306H,
         ICDAS73 = MB_306I,
         ICDAS74 = MB_306J,
         ICDAS75 = MB_306K,
         COP55 = MB_305B,
         COP54 = MB_305C,
         COP53 = MB_305D,
         COP52 = MB_305E,
         COP51 = MB_305F,
         COP61 = MB_305G,
         COP62 = MB_305H,
         COP63 = MB_305I,
         COP64 = MB_305J,
         COP65 = MB_305K,
         COP85 = MB_307B,
         COP84 = MB_307C,
         COP83 = MB_307D,
         COP82 = MB_307E,
         COP81 = MB_307F,
         COP71 = MB_307G,
         COP72 = MB_307H,
         COP73 = MB_307I,
         COP74 = MB_307J,
         COP75 = MB_307K)
```

Caries experience: with ICDAS

Experiencia modificada: includes cavitaded and non-cavitaded carious lesions.

304: ICDAS 55-65
306: ICDAS 85-75

Caries if:
* 2: first/distinct visual change in enamel (ICDAS 1 and 2)
* 3: Localized enamel breakdown (considered cavitated) (ICDAS 3)
* 4: underlying dark shadow from dentin without enamel breakdown (ICDAS 4)
* 5: distinc cavity with visible dentin (ICDAS 5)
* 6: extensive cavity with visible dentin (ICDAS 6)

2 is non-cavitated, 3-6 are cavitated.

Not caries if:
0 or 9

New categorization:
* No caries: 0 if 0 or 9
* Non-cavitated: 1 if 2
* Cavitated: 2 if 3, 4, 5 or 6

dmft including non-cavitated lessions

```{r}
#Assign a value to 1 to the following numbers: 2, 3, 4, 5, 6

head(examen5$ICDAS55, 20)
examen5 <- examen5 %>%
  mutate(
    across(
      starts_with("ICDAS"),
      ~case_when(
        str_detect(., "^[23456]$") ~ 1,
        TRUE ~ 0)
    ))
head(examen5$ICDAS55, 20)
```

dmft: cavitated and non-cavitated

Only count missing and filled, decayed is being counted with ICDAS classification.

1 if: C (filled with caries), D (filled without caries), E (missing due to caries), G (prosthesis, crown, retainer, veneer)
0 if: A (healthy), F (sealant), H (not registered), B (cavitated)


```{r}
#Assign a value of 1 to the following letters:

head(examen5$COP51, 20)
examen5 <- examen5 %>%
  mutate(
    across(
      starts_with("COP"),
      ~case_when(
        str_detect(., "[CDEG]") ~ 1,
        TRUE ~ 0)
    ))
head(examen5$COP51, 20)

#Create variable dmft_ICDAS that includes the sum of both ICDAS and COP variables

#first: create dummy variable for each tooth that assings 1 if either ICDAS or COP is greater than 0, 0 otherwise. For example, if ICDAS51 is 1, then dmft51 = 1. If COP51 is 1, then dmft51 = 1. If both are 1, then dmft51 = 1. If both are 0, then dmft51 = 0.

examen5 <- examen5 %>%
  mutate(score55 = case_when(
    ICDAS55 > 0 | COP55 > 0 ~ 1, TRUE ~ 0),
    score54 = case_when(
    ICDAS54 > 0 | COP54 > 0 ~ 1, TRUE ~ 0),
    score53 = case_when(
    ICDAS53 > 0 | COP53 > 0 ~ 1, TRUE ~ 0),
    score52 = case_when(
    ICDAS52 > 0 | COP52 > 0 ~ 1, TRUE ~ 0),
    score51 = case_when(
    ICDAS51 > 0 | COP51 > 0 ~ 1, TRUE ~ 0),
    score61 = case_when(
    ICDAS61 > 0 | COP61 > 0 ~ 1, TRUE ~ 0),
    score62 = case_when(
    ICDAS62 > 0 | COP62 > 0 ~ 1, TRUE ~ 0),
    score63 = case_when(
    ICDAS63 > 0 | COP63 > 0 ~ 1, TRUE ~ 0),
    score64 = case_when(
    ICDAS64 > 0 | COP64 > 0 ~ 1, TRUE ~ 0),
    score65 = case_when(
    ICDAS65 > 0 | COP65 > 0 ~ 1, TRUE ~ 0),
    score85 = case_when(
    ICDAS85 > 0 | COP85 > 0 ~ 1, TRUE ~ 0),
    score84 = case_when(
    ICDAS84 > 0 | COP84 > 0 ~ 1, TRUE ~ 0),
    score83 = case_when(
    ICDAS83 > 0 | COP83 > 0 ~ 1, TRUE ~ 0),
    score82 = case_when(
    ICDAS82 > 0 | COP82 > 0 ~ 1, TRUE ~ 0),
    score81 = case_when(
    ICDAS81 > 0 | COP81 > 0 ~ 1, TRUE ~ 0),
    score71 = case_when(
    ICDAS71 > 0 | COP71 > 0 ~ 1, TRUE ~ 0),
    score72 = case_when(
    ICDAS72 > 0 | COP72 > 0 ~ 1, TRUE ~ 0),
    score73 = case_when(
    ICDAS73 > 0 | COP73 > 0 ~ 1, TRUE ~ 0),
    score74 = case_when(
    ICDAS74 > 0 | COP74 > 0 ~ 1, TRUE ~ 0),
    score75 = case_when(
    ICDAS75 > 0 | COP75 > 0 ~ 1, TRUE ~ 0))

#sum the dummy variables
examen5 <- examen5 %>%
  mutate(dmft_ICDAS = rowSums(across(starts_with("score"), ~. > 0)))

summary(examen5$dmft_ICDAS) #now the max is 20

#See distribution

ggplot(data = examen5, aes(x = dmft_ICDAS)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score for 1 and 3 years old")
```

Caries experience based on dmft_ICDAS

```{r}
examen5 <- examen5 %>%
  mutate(cariesexp = case_when(
    dmft_ICDAS > 0 ~ 1,
    TRUE ~ 0
  )) %>%
  mutate(cariesexp = factor(cariesexp, levels = c(0, 1), labels = c("No caries", "Caries")))

summary(examen5$cariesexp)
```

dmft

```{r}
#Assign a value to 1 to the following numbers: 1, 2, 3, 4, 7
examen5 <- examen5 %>%
  mutate(
    across(
      starts_with("MB_3"),
      ~case_when(
        str_detect(., "^[12347]$|^[BCDEG]$") ~ 1,
        TRUE ~ 0                                 
      )))

#create variable dmft
examen5 <- examen5 %>%
  mutate(dmft = rowSums(across(starts_with("MB_3"), ~. > 0))) %>%
  dplyr::select(-starts_with("MB_3"))

summary(examen5$dmft)

#See distribution
ggplot(data = examen5, aes(x = dmft)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score for 5 years old")
```

Merge datasets:

```{r}
ensab <- ninos %>%
  left_join(examen13, by = "ID_PERSONA") %>%
  left_join(examen5, by = "ID_PERSONA") %>%
  mutate(dmft = coalesce(dmft.x, dmft.y),
         dmft_ICDAS = coalesce(dmft_ICDAS.x, dmft_ICDAS.y),
         cariesexp = coalesce(cariesexp.x, cariesexp.y),
         ID_HOGAR = coalesce(ID_HOGAR.x, ID_HOGAR.y)) %>%
  dplyr::select(-ID_HOGAR.x, -ID_HOGAR.y, -dmft.x, -dmft.y)

#Missing data

ensab %>%
  filter(MA_208 == 2 | MB_208 == 2) %>%
  count()

ensab <- ensab %>%
  filter(MA_208 == 1 | MB_208 == 1) %>%
  dplyr::select(-MB_208, -MA_208)

#only  3 children did not have the clinical examination portion. We'll exclude them. Now the sample size is 6443 children.
```

### Distribution and summary of outcome

```{r}
ggplot(data = ensab, aes(x = dmft)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score")

summary(ensab$dmft)

ggplot(data = ensab, aes(x = dmft_ICDAS)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score based on ICDAS")
#looks much more different, as it is counting all stages of cavities now

summary(ensab$dmft_ICDAS)

summary(ensab$cariesexp)

```

# Key variables

Age: M3_100C

It really is categorical and not continuous.

```{r}
glimpse(ensab$M3_100C)
summary(ensab$M3_100C)

#rename M2_100C to age
ensab <- ensab %>%
  rename(age = M3_100C) %>%
  mutate(age = factor(age, 
                      levels = c(1, 3, 5),
                      labels = c("1", "3", "5")))

summary(ensab$age)
```


## Exposure: Nutrition

M3_229AA, M3_229AB, M3_229BA, M3_229BB, M3_229CA, M3_229CB, M3_229DA, M3_229DB, M3_229EA, M3_229EB, M3_229FA, M3_229FB, M3_229GA, M3_229GB, M3_229HA, M3_229HB, M3_229IA, M3_229IB,

A.	Cereals, roots, tubers, plantain: carbs
B.	Vegetables, greens, green legumes: veg
C.	Fruits: fruit
D.	Meat, eggs, dried legumes and vegetables: prot
E.	Dairy products: dairy
F.	Fats and oils: fats
G.	Sugars and sweets: sugar
H.	Sodas and soft drinks: soda
I.	Juices, natural or artificial: juice

carbs, veg, fruit, prot, dairy, fats, sugar, soda, juice

```{r}

#make all variables starting with M3_229 to numeric

ensab <- ensab %>%
  mutate(across(starts_with("M3_229"), as.numeric))

#frequency of each variable

ensab %>%
  dplyr::select(M3_229AA:M3_229IB) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(Frequency = n(), .groups = "drop") %>%
  arrange(Variable, desc(Value)) %>%
  print(n = 100)

ensab %>%
  group_by(M3_229AA, M3_229AB) %>%
  count()

#renaming variables for interpretation

ensab <- ensab %>%
  rename(carbs_week = M3_229AA, 
         carbs_day = M3_229AB, 
         veg_week = M3_229BA, 
         veg_day = M3_229BB, 
         fruit_week = M3_229CA, 
         fruit_day = M3_229CB, 
         prot_week = M3_229DA, 
         prot_day = M3_229DB, 
         dairy_week = M3_229EA, 
         dairy_day = M3_229EB, 
         fats_week = M3_229FA, 
         fats_day = M3_229FB, 
         sugar_week = M3_229GA, 
         sugar_day = M3_229GB, 
         soda_week = M3_229HA, 
         soda_day = M3_229HB, 
         juice_week = M3_229IA, 
         juice_day = M3_229IB)

#categorizing with factor for weekly and daily intake

ensab <- ensab %>%
  mutate(across(contains("week"), ~ factor(., 
    levels = c(1, 2, 3, 4),
    labels = c("Never", "1x", "2-3x", "4-6x")
    )))

ensab <- ensab %>%
  mutate(across(contains("day"), ~ case_when( 
    is.na(.) ~ 0,
    . == 3 ~ NA,
    TRUE ~ .))) %>%
  mutate(across(contains("day"), ~ factor(., 
    levels = c(0, 1, 2),
    labels = c("Never", "1x", "2+x")
  )))

# frequency of weekly and daily intake

ensab %>%
  group_by(carbs_week, carbs_day) %>%
  count()

ensab %>%
  group_by(veg_week, veg_day) %>%
  count()

ensab %>%
  group_by(fruit_week, fruit_day) %>%
  count()

ensab %>%
  group_by(prot_week, prot_day) %>%
  count()

ensab %>%
  group_by(dairy_week, dairy_day) %>%
  count()

ensab %>%
  group_by(fats_week, fats_day) %>%
  count()

ensab %>%
  group_by(sugar_week, sugar_day) %>%
  count()

ensab %>%
  group_by(soda_week, soda_day) %>%
  count()

ensab %>%
  group_by(juice_week, juice_day) %>%
  count()

```

### Nutrition index for each category

```{r}

ensab <- ensab %>%
  mutate(carbs = case_when(
    carbs_week == "Never" & carbs_day == "Never" ~ 0,
    carbs_week == "1x" & carbs_day == "1x" ~ 1,
    carbs_week == "1x" & carbs_day == "2+x" ~ 2,
    carbs_week == "2-3x" & carbs_day == "1x" ~ 3,
    carbs_week == "2-3x" & carbs_day == "2+x" ~ 4,
    carbs_week == "4-6x" & carbs_day == "1x" ~ 5,
    carbs_week == "4-6x" & carbs_day == "2+x" ~ 6,
    is.na(carbs_day) ~ NA))

summary(ensab$carbs)
ggplot(data = ensab, aes(x = carbs)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Carbs Index score", y = "Participants", title = "Distribution of Carbs Index score")

# collapse carbs 2 and 3, and 4 and 5

ensab <- ensab %>%
  mutate(carbs = case_when(
    carbs == 3 ~ 2,  # Recode 3 to 2
    carbs == 4 ~ 3,  # Recode 4 to 3
    carbs == 5 ~ 3,  # Recode 5 to 3
    carbs == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ carbs     # Keep other values unchanged
  )) %>%
  mutate(carbs = factor(carbs,
                        levels = c(0, 1, 2, 3, 4),
                        labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$carbs)

ggplot(data = ensab, aes(x = carbs)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Carbs Index score", y = "Participants", title = "Distribution of Carbs Index score recoded")
```


```{r}
#Vegetables

ensab <- ensab %>%
  mutate(veg = case_when(
    veg_week == "Never" & veg_day == "Never" ~ 0,
    veg_week == "1x" & veg_day == "1x" ~ 1,
    veg_week == "1x" & veg_day == "2+x" ~ 2,
    veg_week == "2-3x" & veg_day == "1x" ~ 3,
    veg_week == "2-3x" & veg_day == "2+x" ~ 4,
    veg_week == "4-6x" & veg_day == "1x" ~ 5,
    veg_week == "4-6x" & veg_day == "2+x" ~ 6,
    is.na(veg_day) ~ NA))

summary(ensab$veg)
ggplot(data = ensab, aes(x = veg)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Veg Index score", y = "Participants", title = "Distribution of Veg Index score")

# collapse veg 2 and 3, and 4 and 5

summary(ensab$veg)

ensab <- ensab %>%
  mutate(veg = case_when(
    veg == 3 ~ 2,  # Recode 3 to 2
    veg == 4 ~ 3,  # Recode 4 to 3
    veg == 5 ~ 3,  # Recode 5 to 3
    veg == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ veg     # Keep other values unchanged
  )) %>%
  mutate(veg = factor(veg,
                        levels = c(0, 1, 2, 3, 4),
                        labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$veg)

ggplot(data = ensab, aes(x = veg)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Veg Index score", y = "Participants", title = "Distribution of Veg Index score recoded")

#Fruit

ensab <- ensab %>%
  mutate(fruit = case_when(
    fruit_week == "Never" & fruit_day == "Never" ~ 0,
    fruit_week == "1x" & fruit_day == "1x" ~ 1,
    fruit_week == "1x" & fruit_day == "2+x" ~ 2,
    fruit_week == "2-3x" & fruit_day == "1x" ~ 3,
    fruit_week == "2-3x" & fruit_day == "2+x" ~ 4,
    fruit_week == "4-6x" & fruit_day == "1x" ~ 5,
    fruit_week == "4-6x" & fruit_day == "2+x" ~ 6,
    is.na(fruit_day) ~ NA))

summary(ensab$fruit)
ggplot(data = ensab, aes(x = fruit)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Fruit Index score", y = "Participants", title = "Distribution of Fruit Index score")

# collapse fruit 2 and 3, and 4 and 5

summary(ensab$fruit)

ensab <- ensab %>%
  mutate(fruit = case_when(
    fruit == 3 ~ 2,  # Recode 3 to 2
    fruit == 4 ~ 3,  # Recode 4 to 3
    fruit == 5 ~ 3,  # Recode 5 to 3
    fruit == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ fruit     # Keep other values unchanged
  )) %>%
  mutate(fruit = factor(fruit,
                        levels = c(0, 1, 2, 3, 4),
                        labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$fruit)
ggplot(data = ensab, aes(x = fruit)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Fruit Index score", y = "Participants", title = "Distribution of Fruit Index score recoded")


#Protein

ensab <- ensab %>%
  mutate(prot = case_when(
    prot_week == "Never" & prot_day == "Never" ~ 0,
    prot_week == "1x" & prot_day == "1x" ~ 1,
    prot_week == "1x" & prot_day == "2+x" ~ 2,
    prot_week == "2-3x" & prot_day == "1x" ~ 3,
    prot_week == "2-3x" & prot_day == "2+x" ~ 4,
    prot_week == "4-6x" & prot_day == "1x" ~ 5,
    prot_week == "4-6x" & prot_day == "2+x" ~ 6,
    is.na(prot_day) ~ NA))

summary(ensab$prot)
ggplot(data = ensab, aes(x = prot)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Prot Index score", y = "Participants", title = "Distribution of Prot Index score")

summary(ensab$prot)

ensab <- ensab %>%
  mutate(prot = case_when(
    prot == 3 ~ 2,  # Recode 3 to 2
    prot == 4 ~ 3,  # Recode 4 to 3
    prot == 5 ~ 3,  # Recode 5 to 3
    prot == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ prot     # Keep other values unchanged
  )) %>%
  mutate(prot = factor(prot,
                       levels = c(0, 1, 2, 3, 4),
                       labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$prot)
summary(ensab$prot)
ggplot(data = ensab, aes(x = prot)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Prot Index score", y = "Participants", title = "Distribution of Prot Index score recoded")

#dairy

ensab <- ensab %>%
  mutate(dairy = case_when(
    dairy_week == "Never" & dairy_day == "Never" ~ 0,
    dairy_week == "1x" & dairy_day == "1x" ~ 1,
    dairy_week == "1x" & dairy_day == "2+x" ~ 2,
    dairy_week == "2-3x" & dairy_day == "1x" ~ 3,
    dairy_week == "2-3x" & dairy_day == "2+x" ~ 4,
    dairy_week == "4-6x" & dairy_day == "1x" ~ 5,
    dairy_week == "4-6x" & dairy_day == "2+x" ~ 6,
    is.na(dairy_day) ~ NA))

summary(ensab$dairy)
ggplot(data = ensab, aes(x = dairy)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Dairy Index score", y = "Participants", title = "Distribution of Dairy Index score")

summary(ensab$dairy)

ensab <- ensab %>%
  mutate(dairy = case_when(
    dairy == 3 ~ 2,  # Recode 3 to 2
    dairy == 4 ~ 3,  # Recode 4 to 3
    dairy == 5 ~ 3,  # Recode 5 to 3
    dairy == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ dairy     # Keep other values unchanged
  )) %>%
  mutate(dairy = factor(dairy,
                        levels = c(0, 1, 2, 3, 4),
                        labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$dairy)
summary(ensab$dairy)
ggplot(data = ensab, aes(x = dairy)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Dairy Index score", y = "Participants", title = "Distribution of Dairy Index score recoded")

#Fats

ensab <- ensab %>%
  mutate(fats = case_when(
    fats_week == "Never" & fats_day == "Never" ~ 0,
    fats_week == "1x" & fats_day == "1x" ~ 1,
    fats_week == "1x" & fats_day == "2+x" ~ 2,
    fats_week == "2-3x" & fats_day == "1x" ~ 3,
    fats_week == "2-3x" & fats_day == "2+x" ~ 4,
    fats_week == "4-6x" & fats_day == "1x" ~ 5,
    fats_week == "4-6x" & fats_day == "2+x" ~ 6,
    is.na(fats_day) ~ NA))

summary(ensab$fats)
ggplot(data = ensab, aes(x = fats)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Fats Index score", y = "Participants", title = "Distribution of Fats Index score")

summary(ensab$fats)

ensab <- ensab %>%
  mutate(fats = case_when(
    fats == 3 ~ 2,  # Recode 3 to 2
    fats == 4 ~ 3,  # Recode 4 to 3
    fats == 5 ~ 3,  # Recode 5 to 3
    fats == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ fats     # Keep other values unchanged
  )) %>%
  mutate(fats = factor(fats,
                       levels = c(0, 1, 2, 3, 4),
                       labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$fats)
ggplot(data = ensab, aes(x = fats)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Fats Index score", y = "Participants", title = "Distribution of Fats Index score recoded")

#Sugar

ensab <- ensab %>%
  mutate(sugar = case_when(
    sugar_week == "Never" & sugar_day == "Never" ~ 0,
    sugar_week == "1x" & sugar_day == "1x" ~ 1,
    sugar_week == "1x" & sugar_day == "2+x" ~ 2,
    sugar_week == "2-3x" & sugar_day == "1x" ~ 3,
    sugar_week == "2-3x" & sugar_day == "2+x" ~ 4,
    sugar_week == "4-6x" & sugar_day == "1x" ~ 5,
    sugar_week == "4-6x" & sugar_day == "2+x" ~ 6,
    is.na(sugar_day) ~ NA))

summary(ensab$sugar)

ggplot(data = ensab, aes(x = sugar)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Sugar Index score", y = "Participants", title = "Distribution of Sugar Index score")

summary(ensab$sugar)

ensab <- ensab %>%
  mutate(sugar = case_when(
    sugar == 3 ~ 2,  # Recode 3 to 2
    sugar == 4 ~ 3,  # Recode 4 to 3
    sugar == 5 ~ 3,  # Recode 5 to 3
    sugar == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ sugar     # Keep other values unchanged
  )) %>%
  mutate(sugar = factor(sugar,
                        levels = c(0, 1, 2, 3, 4),
                        labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$sugar)
ggplot(data = ensab, aes(x = sugar)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Sugar Index score", y = "Participants", title = "Distribution of Sugar Index score recoded")

#Soda

ensab <- ensab %>%
  mutate(soda = case_when(
    soda_week == "Never" & soda_day == "Never" ~ 0,
    soda_week == "1x" & soda_day == "1x" ~ 1,
    soda_week == "1x" & soda_day == "2+x" ~ 2,
    soda_week == "2-3x" & soda_day == "1x" ~ 3,
    soda_week == "2-3x" & soda_day == "2+x" ~ 4,
    soda_week == "4-6x" & soda_day == "1x" ~ 5,
    soda_week == "4-6x" & soda_day == "2+x" ~ 6,
    is.na(soda_day) ~ NA))

summary(ensab$soda)
ggplot(data = ensab, aes(x = soda)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Soda Index score", y = "Participants", title = "Distribution of Soda Index score")

summary(ensab$soda)

ensab <- ensab %>%
  mutate(soda = case_when(
    soda == 3 ~ 2,  # Recode 3 to 2
    soda == 4 ~ 3,  # Recode 4 to 3
    soda == 5 ~ 3,  # Recode 5 to 3
    soda == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ soda     # Keep other values unchanged
  )) %>%
  mutate(soda = factor(soda,
                       levels = c(0, 1, 2, 3, 4),
                       labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$soda)
ggplot(data = ensab, aes(x = soda)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Soda Index score", y = "Participants", title = "Distribution of Soda Index score recoded")


#Juice

ensab <- ensab %>%
  mutate(juice = case_when(
    juice_week == "Never" & juice_day == "Never" ~ 0,
    juice_week == "1x" & juice_day == "1x" ~ 1,
    juice_week == "1x" & juice_day == "2+x" ~ 2,
    juice_week == "2-3x" & juice_day == "1x" ~ 3,
    juice_week == "2-3x" & juice_day == "2+x" ~ 4,
    juice_week == "4-6x" & juice_day == "1x" ~ 5,
    juice_week == "4-6x" & juice_day == "2+x" ~ 6,
    is.na(juice_day) ~ NA)) 

summary(ensab$juice)
ggplot(data = ensab, aes(x = juice)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Juice Index score", y = "Participants", title = "Distribution of Juice Index score")

summary(ensab$juice)

ensab <- ensab %>%
  mutate(juice = case_when(
    juice == 3 ~ 2,  # Recode 3 to 2
    juice == 4 ~ 3,  # Recode 4 to 3
    juice == 5 ~ 3,  # Recode 5 to 3
    juice == 6 ~ 4,  # Recode 6 to 4
    TRUE ~ juice     # Keep other values unchanged
  )) %>%
  mutate(juice = factor(juice,
                        levels = c(0, 1, 2, 3, 4),
                        labels = c("Never", "1x", "2-3x", "4-7x", "8+x")))
summary(ensab$juice)
ggplot(data = ensab, aes(x = juice)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "Juice Index score", y = "Participants", title = "Distribution of Juice Index score recoded")
```

### NAs in all nutrition variables

```{r}
#check for NAs in all nutrition variables

missingnut <- ensab %>%
  dplyr::select(carbs, veg, fruit, prot, dairy, fats, sugar, soda, juice) %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "NAs") %>%
  arrange(desc(NAs))
missingnut

#proportion of missing values
sum(missingnut$NAs)/nrow(ensab) #1.3%, so will exclude. Should now have at least 6355 observations

ensab <- ensab %>%
  filter(!is.na(carbs) & !is.na(veg) & !is.na(fruit) & !is.na(prot) & !is.na(dairy) & !is.na(fats) & !is.na(sugar) & !is.na(soda) & !is.na(juice))
#Now we have 6382 observations, which means most of this NAs were from the same participants. 
6443-6382 #61 participants had at least one missing value in the nutrition variables

#check if there are still NAs

ensab %>%
  dplyr::select(carbs, veg, fruit, prot, dairy, fats, sugar, soda, juice) %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "NAs") %>%
  arrange(desc(NAs)) #no NAs now

6382/6446*100
#retained 99% of the sample
```


## Possible confounders or EMM

### Demographic variables

Sex: Sexo

Couldn't find the codification in the codebook so I had to guess.

```{r}
glimpse(ensab$Sexo)

ensab <- ensab %>%
  mutate(sex = factor(Sexo,
                         levels = c(1, 2),
                         labels = c("Masculine", "Feminine")))

summary(ensab$sex)
```

Ethnicity: M3_113D

Decided not to include ethnicity because of 5772 missing values

```{r}
glimpse(ensab$M3_113D)

ensab %>%
  group_by(M3_113D) %>%
  count()
```

### Socioeconomic position

Socioeconomic status: EST_SE_2
```{r}
glimpse(ensab$EST_SE_2)

ensab <- ensab %>%
  mutate(ses = factor(EST_SE_2, 
                           levels = c(1, 2, 3, 4), 
                           labels = c("Low low", "Low", "Middle low", "Middle to high")))

summary(ensab$ses)
```

Income: M3_119

NMW: national minimum wage (salario minimo legal vigente)

```{r}
glimpse(ensab$M3_119)

ensab %>%
  group_by(M3_119) %>%
  count()

#8 are NAs
ensab %>%
  filter(M3_119 == 8) %>%
  count() #95 NAs

#transform 7 unemployed into 0

ensab <- ensab %>%
  mutate(income = case_when(
    M3_119 == 8 ~ NA,
    M3_119 == 7 ~ 0,
    TRUE ~ M3_119)) %>%
  mutate(income = factor(income,
                         levels = c(0, 1, 2, 3, 4, 5, 6),
                         labels = c("Unemployed", "Less than half NMW", "Half - 1 NMW", "1-2 NMW", "2-3 NMW", "3-4 NMW", "More than 4 NMW")))

summary(ensab$income)

```

Educational level of the provider: M3_113F

Decided to exclude because there are 5772 missing values

```{r}
glimpse(ensab$M3_113F)

ensab %>%
  group_by(M3_113F) %>%
  count()

```


Health insurance coverage/scheme:

Chose REGIMEN over M3_113E because it has less categories plus no missing values, and it reflects the insurance status of the child and not the main provider.

```{r}
glimpse(ensab$REGIMEN)

#counting NAs in M3_113E

ensab %>%
  filter(M3_113E == 6) %>%
  count()

ensab <- ensab %>%
  mutate(insurance = case_when(
    REGIMEN == 4 ~ 0,
    TRUE ~ REGIMEN)) %>%
  mutate(insurance = factor(insurance, 
                           levels = c(0, 1, 2, 3), 
                           labels = c("Uninsured", "Contributory", "Subsidized", "Other")))

summary(ensab$insurance)
```

### Location 

Region

```{r}
glimpse(ensab$Region)

ensab <- ensab %>%
  mutate(region = factor(Region,
                         levels = c(1, 2, 3, 4, 5, 6),
                         labels = c("Atlantic", "Eastern", "Central", "Pacific", "Bogota", "Orinoquia - Amazonia")))

summary(ensab$region)
```

Urban vs rural: Zona

Will be named location
Chose Zona over Clase because it has more universal categories (rural and urban), while Clase has categories according to the national census. However, it has more granularity and could be useful.

```{r}
glimpse(ensab$Zona)

ensab %>%
  group_by(Zona, .drop = FALSE) %>%
  count()

ensab <- ensab %>%
  mutate(location = factor(Zona,
                           levels = c(1, 2),
                           labels = c("Urban", "Rural")))

summary(ensab$location)
```

### Potentially interesting variables to check for EMM

M3_201: Where the child spends most of their time
Could categorize into home or not home

M3_202: Who takes care of the child
1: Mother or father
2: Relative who is overage

```{r}
ensab %>%
  group_by(M3_201) %>%
  count()

ensab %>%
  group_by(M3_202) %>%
  count()
```

# Characteristics of sample: Table 1


## Account for survey design and weights

checking how many children share the same household
```{r}
ensab %>%
  group_by(ID_HOGAR) %>%
  count() %>%
  arrange(desc(n)) %>%
  filter(n > 1) %>%
  rename(cph = n) %>%
  group_by(cph) %>%
  summarise(prop = n() / nrow(ensab) * 100)

#737 children share the same household with another child included in the study. We won't take it into account for now.
```

Primary sampling unit: municipality

Sampling strata: Could be region or subregion

Documentation about survey package, and understanding finite population correction (fpc)

```{r}

ensab %>%
  group_by(Subreg) %>%
  count()

#Region as strata
survensab <- svydesign(
  ids = ~census_mpio, 
  data = ensab, 
  strata = ~Region, 
  weights = ~Fex_fin, 
  nest = TRUE
)

#calculate fpc

reg_raw <- table(ensab$Region)
reg_exp <- svytable(~Region, design = survensab) #expanded number of participants 
reg_raw
reg_exp
sum(reg_raw)
sum(reg_exp)

#checking ratio of raw vs expanded
sum(reg_raw)/sum(reg_exp)

#total sample checking ratio of raw vs expanded
1498/5215631

#calculate the proportion of the population sampled in each region
reg_prop <- reg_raw/reg_exp
reg_prop

ensab <- ensab %>%
  mutate(region_prop = case_when(
    Region == 1 ~ reg_prop[1],
    Region == 2 ~ reg_prop[2],
    Region == 3 ~ reg_prop[3],
    Region == 4 ~ reg_prop[4],
    Region == 5 ~ reg_prop[5],
    Region == 6 ~ reg_prop[6]
  ))

ensab %>%
  group_by(Region) %>%
  summarise(prop = mean(region_prop)) #checking the values for fpc are correct

survensab <- svydesign(
  ids = ~census_mpio, 
  data = ensab, 
  strata = ~Region, 
  weights = ~Fex_fin, 
  nest = TRUE,
  options = list(survey.lonely.psu = "adjust"),
  fpc = ~region_prop)

sum(reg_exp)
sum(ensab$Fex_fin)

#adding fpc still didn't work. Using subregion as strata for now

#Subregion as strata
survensab <- svydesign(
  ids = ~census_mpio, 
  data = ensab, 
  strata = ~Subreg, 
  weights = ~Fex_fin, 
  nest = TRUE
)

summary(survensab)

#svymean(~cariesexp, design = survensab)
#Error in onestrat(`attr<-`(x[index, , drop = FALSE], "recentering", recentering),  : 
#  Stratum (7) has only one PSU at stage 1

#adjust, certainty, remove
  
```

## Table 1 stratified by outcome (caries or no caries)

```{r}
#Total sample

table(ensab$cariesexp)
svytable(~cariesexp, design = survensab)

```

Age

```{r}
age_total <- prop.table(svytable(~age, design = survensab))
age_total <- round(age_total * 100, 2)
age_total

#by outcome (caries experience)
summary(ensab$cariesexp)
age_caries <- prop.table(svytable(~age, design = subset(survensab, cariesexp == "Caries")))
age_caries <- round(age_caries * 100, 2)
age_caries

age_nocaries <- prop.table(svytable(~age, design = subset(survensab, cariesexp == "No caries")))
age_nocaries <- round(age_nocaries * 100, 2)
age_nocaries
```

Sex

```{r}
sex_total <- prop.table(svytable(~sex, design = survensab))
sex_total <- round(sex_total * 100, 2)
sex_total

#by outcome (cariesexp)

sex_caries <-  prop.table(svytable(~sex, design = subset(survensab, cariesexp == "Caries")))
sex_caries <- round(sex_caries * 100, 2)
sex_caries

sex_nocaries <- prop.table(svytable(~sex, design = subset(survensab, cariesexp == "No caries")))
sex_nocaries <- round(sex_nocaries*100, 2)
sex_nocaries
```

Socioeconomic status

```{r}
ses_total <- prop.table(svytable(~ses, design = survensab))
ses_total <- round(ses_total * 100, 2)
ses_total

#by outcome (cariesexp)

ses_caries <- prop.table(svytable(~ses, design = subset(survensab, cariesexp == "Caries")))
ses_caries <- round(ses_caries * 100, 2)
ses_caries

ses_nocaries <- prop.table(svytable(~ses, design = subset(survensab, cariesexp == "No caries")))
ses_nocaries <- round(ses_nocaries * 100, 2)
ses_nocaries

```

Income

```{r}
income_total <- prop.table(svytable(~income, design = survensab))
income_total <- round(income_total * 100, 2)
income_total

#by outcome (cariesexp)

income_caries <- prop.table(svytable(~income, design = subset(survensab, cariesexp == "Caries")))
income_caries <- round(income_caries * 100, 2)
income_caries

income_nocaries <- prop.table(svytable(~income, design = subset(survensab, cariesexp == "No caries")))
income_nocaries <- round(income_nocaries * 100, 2)
income_nocaries

```

Region

```{r}
region_total <- prop.table(svytable(~region, design = survensab))
region_total <- round(region_total * 100, 2)
region_total
paste(region_total, collapse = " ")

#by outcome (cariesexp)

region_caries <- prop.table(svytable(~region, design = subset(survensab, cariesexp == "Caries")))
region_caries <- round(region_caries * 100, 2)
region_caries
paste(region_caries, collapse = " ")

region_nocaries <- prop.table(svytable(~region, design = subset(survensab, cariesexp == "No caries")))
region_nocaries <- round(region_nocaries * 100, 2)
region_nocaries
paste(region_nocaries, collapse = " ")

```

Area of residence

```{r}
location_total <- prop.table(svytable(~location, design = survensab))
location_total <- round(location_total * 100, 2)
location_total

#by outcome (cariesexp)

location_caries <- prop.table(svytable(~location, design = subset(survensab, cariesexp == "Caries")))
location_caries <- round(location_caries * 100, 2)
location_caries

location_nocaries <- prop.table(svytable(~location, design = subset(survensab, cariesexp == "No caries")))
location_nocaries <- round(location_nocaries * 100, 2)
location_nocaries

```

Insurance

```{r}
insurance_total <- prop.table(svytable(~insurance, design = survensab))
insurance_total <- round(insurance_total * 100, 2)
insurance_total

#by outcome (cariesexp)

insurance_caries <- prop.table(svytable(~insurance, design = subset(survensab, cariesexp == "Caries")))
insurance_caries <- round(insurance_caries * 100, 2)
insurance_caries

insurance_nocaries <- prop.table(svytable(~insurance, design = subset(survensab, cariesexp == "No caries")))
insurance_nocaries <- round(insurance_nocaries * 100, 2)
insurance_nocaries

```

### Age of first dental visit (agefdv)

It is composed of:
- M3_206A: numeric
- M3_206B: 1: months, 2: years

Take into account M3_205: have they ever had an appointment with a dentist?  
1: yes, 2: no, 3: doesn't know

Combine 206A and 205 to categorize.

```{r}
#Turn M3_206A into a numeric variable
ensab$M3_206A <- as.numeric(ensab$M3_206A)

summary(ensab$M3_206A)

ensab %>%
  filter(M3_205 == 2 | M3_205 == 3) %>%
  count()
#2648: coincides with the number of NAs

ensab %>%
  filter(M3_205 == 3) %>%
  count()
#only 46 participants have missing values for M3_205

#multiply values in the filtered rows by 12 and categorize
ensab <- ensab %>%
  mutate(agefdv = if_else(M3_206B == 2, M3_206A * 12, M3_206A))

ggplot(ensab, aes(x = agefdv)) +
  geom_histogram(fill = "skyblue", color = "black") +
  scale_x_continuous(breaks = seq(min(ensab$agefdv, na.rm = TRUE), max(ensab$agefdv, na.rm = TRUE), by = 6)) +
  labs(x = "Age of first dental visit", y = "Participants", title = "Distribution of age of first dental visit")

# can do bins 0-6, 7-12, 13-24, 25-36, 37-48, 49-72, or just divide into 3.

ensab <- ensab %>%
  mutate(agefdv = case_when(
    M3_205 == 3 ~ NA_real_,
    M3_205 == 2 ~ 0,
    agefdv <= 12 ~ 1,
    agefdv > 12 ~ 2,
    TRUE ~ agefdv)) %>%
  mutate(agefdv = factor(agefdv, 
                         levels = c(0, 1, 2), 
                         labels = c("Never", "0-12", "13+")))

summary(ensab$agefdv)

ensab <- ensab %>%
  dplyr::select(-M3_206B, -M3_206A)
```

Proportions

```{r}

survensab <- svydesign(
  ids = ~census_mpio, 
  data = ensab, 
  strata = ~Subreg, 
  weights = ~Fex_fin, 
  nest = TRUE
)

agefdv_total <- prop.table(svytable(~factor(agefdv, exclude = NULL), design = survensab))
agefdv_total <- round(agefdv_total * 100, 2)
agefdv_total

#by outcome (cariesexp)

agefdv_caries <- prop.table(svytable(~factor(agefdv, exclude = NULL), design = subset(survensab, cariesexp == "Caries")))
agefdv_caries <- round(agefdv_caries * 100, 2)
agefdv_caries

agefdv_nocaries <- prop.table(svytable(~factor(agefdv, exclude = NULL), design = subset(survensab, cariesexp == "No caries")))
agefdv_nocaries <- round(agefdv_nocaries * 100, 2)
agefdv_nocaries


```


### Reason for last consultation (reason), will not be included for now

M3_209: 
1: por una urgencia
2: para un tratamiento
3: por revision/prevencion
4: certificado odontologico

M207 Is important: when was the last appointment of the child with the dentist?
1: less than a year ago
2: between 1-2 years
3: more than 3 years
4: does not remember (NA)

### Age of start of dental hygiene = agehyg

M3_213: units are months, continuous
91: doesn't know
92: has never gotten dental hygiene done

```{r}
ensab %>%
  filter(M3_213 == 91 | M3_213 == 92) %>%
  count()
#385

ensab %>%
  filter(M3_213 == 91) %>%
  count()
#NA

ensab %>%
  group_by(age) %>%
  filter(M3_213 == 92) %>%
  count()
#226 children at 1 years old have never gotten dental hygiene done, 4 at age 3 and 2 at age 5

glimpse(ensab$M3_213)

#create distribution
ensab %>%
  filter(!(M3_213 %in% c(91, 92))) %>%
  ggplot(aes(x = M3_213)) +
  geom_histogram(fill = "skyblue", color = "black") +
  scale_x_continuous(breaks = seq(min(ensab$M3_213, na.rm = TRUE), max(ensab$M3_213, na.rm = TRUE), by = 6)) +
  labs(x = "Age of start of dental hygiene", y = "Participants", title = "Distribution of age of start of dental hygiene")

#max value of M3_213 without 91 or 92 using summary only for M3_213

ensab %>%
  filter(!(M3_213 %in% c(91, 92))) %>%
  summary()

#Categorize into: never, 0-6 months, more than 6 months

ensab <- ensab %>%
  mutate(agehyg = case_when(
    M3_213 == 91 ~ NA_real_,
    M3_213 <= 6 ~ 1,
    M3_213 > 6 & M3_213 <= 12 ~ 2,
    M3_213 > 12 & M3_213 <= 36 ~ 3,
    M3_213 == 92 ~ 4
  )) %>%
  mutate(agehyg = factor(agehyg, 
                        levels = c(1, 2, 3, 4),
                        labels = c( "0-6 months", "6-12 months", "+12 months", "Never")))

#Proportions

ensab %>%
  group_by(age, agehyg) %>%
  count() %>%
  group_by(age) %>%
  mutate(prop = n / sum(n) * 100)

```

Proportions with survey design

```{r}
survensab <- svydesign(
  ids = ~census_mpio, 
  data = ensab, 
  strata = ~Subreg, 
  weights = ~Fex_fin, 
  nest = TRUE
)

agehyg_total <- prop.table(svytable(~factor(agehyg, exclude = NULL), design = survensab))
agehyg_total <- round(agehyg_total * 100, 2)
agehyg_total

#by outcome (cariesexp)

agehyg_caries <- prop.table(svytable(~factor(agehyg, exclude = NULL), design = subset(survensab, cariesexp == "Caries")))
agehyg_caries <- round(agehyg_caries * 100, 2)
agehyg_caries

agehyg_nocaries <- prop.table(svytable(~factor(agehyg, exclude = NULL), design = subset(survensab, cariesexp == "No caries")))
agehyg_nocaries <- round(agehyg_nocaries * 100, 2)
agehyg_nocaries

```


### Bottle feeding


# Table 2: Caries experience

```{r}
prop.table(svytable(~cariesexp, design = survensab))

survensab_rep <- as.svrepdesign(
    survensab, 
    type = "bootstrap", 
    replicates = 500
  )

survensab_rep

#cariesexp proportion with bootstrapping standard error (survensab_rep)

prop.table(svymean(~cariesexp, design = survensab_rep))
confint(svymean(~cariesexp, design = survensab_rep))

#as.svrepdesign

(sqrt(0.6775306)*0.3224694)/6382

#accounting for survey design

#svymean(~cariesexp, design = survensab)
#Error in onestrat(`attr<-`(x[index, , drop = FALSE], "recentering", recentering),  : 
#  Stratum (7) has only one PSU at stage 1

if(!require("interpretCI")) install.packages("interpretCI")
library(interpretCI)
prop.table(table(ensab$cariesexp))
propCI(n = 6382, x = 0.6775306, alpha = 0.05)

prop.table(svytable(~cariesexp, design = survensab))

svymean(~cariesexp, design = survensab_rep)

table(ensab$cariesexp)
```

Multi-level logistic regression to account for clustering by subregion and region

```{r}
library(lme4)

maria <- glmer(cariesexp ~ 1| Region, data = ensab, family = "binomial")
summary(maria)

predictedmaria <- predict(maria)

table(predictedmaria)

#without clustering

maria2 <- glm(cariesexp ~ 1, data = ensab, family = "binomial")
summary(maria2)

exp(0.74245-1.96*0.02678)/(1+exp(0.74245-1.96*0.02678))
exp(0.74245+1.96*0.02678)/(1+exp(0.74245+1.96*0.02678))

#.6648452    .6879348

#CI maria

exp(0.74234-1.96*0.09807)/(1+exp(0.74234-1.96*0.09807))
exp(0.74234+1.96*0.09807)/(1+exp(0.74234+1.96*0.09807))

#bootstrapped

0.66719-1.96*0.0191
0.66719+1.96*0.0191

#clustering with subregion and region

maria_subreg <- glmer(cariesexp ~ 1| Region: Subreg, data = ensab, family = "binomial")
summary(maria_subreg)
# confidence intervals
exp(0.7300-1.96*0.1179)/(1+exp(0.7300-1.96*0.1179))
exp(0.7300+1.96*0.1179)/(1+exp(0.7300+1.96*0.1179))

#try adding weights, may not be necessary

#maria_sub_w <- glmer(cariesexp ~ 1| Region: Subreg, weights=Fex_fin, data = ensab, family = "binomial")

glimpse(ensab)
```


## Collapsing categories with few numbers of observations

Socioeconomic status: Collapse "Middle low" into "Middle to high

```{r}
  
summary(ensab$ses)

ensab <- ensab %>%
  mutate(ses = dplyr::recode(ses,
                      "Middle low" = "Middle to high"))

summary(ensab$ses) #middle to high is now 999+94
```

Income: Collapse Unemployed with Less than half NMW and collapse 2-3 NWM, 3-4 NMW and More than 4 NMW

```{r}
summary(ensab$income)
ensab <- ensab %>%
  mutate(income = dplyr::recode(income,
                                "Unemployed" = "Less than half NMW",
                                "2-3 NMW" = "More than 2 NMW",
                                "3-4 NMW" = "More than 2 NMW",
                                "More than 4 NMW" = "More than 2 NMW"))
summary(ensab$income)
summary(as.numeric(ensab$income))
```

Cereals: Collapse Never and Once a week with 2-3 times a week, to <4x (less than four times a week)

```{r}
summary(ensab$carbs)
summary(as.numeric(ensab$carbs))

ensab <- ensab %>%
  mutate(carbs = dplyr::recode(carbs,
                               "Never" = "<4x",
                               "1x" = "<4x",
                               "2-3x" = "<4x"))

summary(ensab$carbs)
summary(as.numeric(ensab$carbs))
```

Fruits: Collapse Never and Once a week into <2x (less than twice a week)

```{r}
summary(ensab$fruit)
ensab <- ensab %>%
  mutate(fruit = dplyr::recode(fruit,
                               "Never" = "<2x",
                               "1x" = "<2x"))
summary(ensab$fruit)
```

Protein:  Collapse Never and Once a week with 2-3 times a week, to <4x (less than four times a week)

```{r}
summary(ensab$prot)
ensab <- ensab %>%
  mutate(prot = dplyr::recode(prot,
                               "Never" = "<4x",
                               "1x" = "<4x",
                               "2-3x" = "<4x"))
summary(ensab$prot)
```

Dairy: Collapse Never and Once a week into <2x (less than twice a week)

```{r}
summary(ensab$dairy)
ensab <- ensab %>%
  mutate(dairy = dplyr::recode(dairy,
                               "Never" = "<2x",
                               "1x" = "<2x"))
summary(ensab$dairy)
```

Juice: Collapse Never and Once a week into <2x (less than twice a week)

```{r}
summary(ensab$juice)
ensab <- ensab %>%
  mutate(juice = dplyr::recode(juice,
                               "Never" = "<2x",
                               "1x" = "<2x"))
summary(ensab$juice)
```

# Association between nutrition and caries

Steps of multivariable analysis:
1. DAG
2. Fit different models
4. Check for multi-collinearity with VIF
5. Check model fit with likelihood ratio test (chi squared): nested models. Backwards or forwards selection


## Table 2: Proportions for each

carbs, veg, fruit, prot, dairy, fats, sugar, soda, juice

### Carbs proportions

```{r}
carbs_total <- prop.table(svytable(~carbs, design = survensab))
carbs_total <- round(carbs_total * 100, 2)
carbs_total

carbsprop <- glmer(carbs ~ 1| Region : Subreg, data = ensab, family = "binomial")
summary(carbsprop)

prop.table(svymean(~carbs, design = survensab_rep))
```


### Vegetables proportions

```{r}
veg_total <- prop.table(svytable(~veg, design = survensab))
veg_total <- round(veg_total * 100, 2)
veg_total
```

Fruits proportions

```{r}
fruit_total <- prop.table(svytable(~fruit, design = survensab))
fruit_total <- round(fruit_total * 100, 2)
fruit_total

```

Protein proportions

```{r}
prot_total <- prop.table(svytable(~prot, design = survensab))
prot_total <- round(prot_total * 100, 2)
prot_total
```

Protein proportions

```{r}
prot_total <- prop.table(svytable(~prot, design = survensab))
prot_total <- round(prot_total * 100, 2)
prot_total
```

Dairy proportions

```{r}
dairy_total <- prop.table(svytable(~dairy, design = survensab))
dairy_total <- round(dairy_total * 100, 2)
dairy_total
```

Fats proportions

```{r}
fats_total <- prop.table(svytable(~fats, design = survensab))
fats_total <- round(fats_total * 100, 2)
fats_total

```

Sugars

```{r}
sugar_total <- prop.table(svytable(~sugar, design = survensab))
sugar_total <- round(sugar_total * 100, 2)
sugar_total

```

Soda

```{r}
soda_total <- prop.table(svytable(~soda, design = survensab))
soda_total <- round(soda_total * 100, 2)
soda_total

```

Juice

```{r}
juice_total <- prop.table(svytable(~juice, design = survensab))
juice_total <- round(juice_total * 100, 2)
juice_total
```

## Table 3: Nested Random intercepts logistic regression

To get OR Random intercept model (rim)

Add every confounder one by one

### Carbs

```{r}
library(MASS) #for stepAIC, but it doesn't work with glmer
library(car) #for vif


# Fit the full model (starting model)
rimfull_carbs <- glmer(cariesexp ~ carbs + (1|Region:Subreg), data = ensab, family = binomial)

# Add one predictor at a time and compare AIC
rim_age_carbs <- update(rimfull_carbs, . ~ . + age)
rim_sex_carbs <- update(rim_age_carbs, . ~ . + sex)
rim_ses_carbs <- update(rim_sex_carbs, . ~ . + ses)
rim_inc_carbs <- update(rim_ses_carbs, . ~ . + income)
rim_loc_carbs <- update(rim_inc_carbs, . ~ . + location)
rim_ins_carbs <- update(rim_loc_carbs, . ~ . + insurance)

# Store models in a list
models_carbs <- list(
  "Full Model"     = rimfull_carbs,
  "Age"            = rim_age_carbs,
  "Sex"            = rim_sex_carbs,
  "SES"            = rim_ses_carbs,
  "Income"         = rim_inc_carbs,
  "Location"       = rim_loc_carbs,
  "Insurance"      = rim_ins_carbs
)

# Compare AIC values
aic_carbs <- sapply(models_carbs, AIC)
aic_carbs <- sort(aic_carbs)

# Print sorted AIC values
print(aic_carbs)

summary(rim_ins_carbs)
exp(fixef(rim_ins_carbs))
#confint(rim_ins_carbs)

#check multicollinearity with VIF
vif(rim_ins_carbs) #it's low

```
### Veg

```{r}
# Fit the full model (starting model)
rimfull_veg <- glmer(cariesexp ~ veg + (1|Region:Subreg), data = ensab, family = binomial)

# Add one predictor at a time and compare AIC
rim_age_veg <- update(rimfull_veg, . ~ . + age)
rim_sex_veg <- update(rim_age_veg, . ~ . + sex)
rim_ses_veg <- update(rim_sex_veg, . ~ . + ses)
rim_inc_veg <- update(rim_ses_veg, . ~ . + income)
rim_loc_veg <- update(rim_inc_veg, . ~ . + location)
rim_ins_veg <- update(rim_loc_veg, . ~ . + insurance)

# Store models in a list
models_veg <- list(
  "Full Model"     = rimfull_veg,
  "Age"            = rim_age_veg,
  "Sex"            = rim_sex_veg,
  "SES"            = rim_ses_veg,
  "Income"         = rim_inc_veg,
  "Location"       = rim_loc_veg,
  "Insurance"      = rim_ins_veg
)

# Compare AIC values
aic_veg <- sapply(models_veg, AIC)
aic_veg <- sort(aic_veg)

# Print sorted AIC values
print(aic_veg)

summary(rim_ins_veg)
exp(fixef(rim_ins_veg))
#confint(rim_ins_veg)

# Check multicollinearity with VIF
vif(rim_ins_veg) # it's low

```
### Fruit

```{r}
# Fit the full model (starting model)
rimfull_fruit <- glmer(cariesexp ~ fruit + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_fruit)

# Add one predictor at a time and compare AIC
rim_age_fruit <- update(rimfull_fruit, . ~ . + age)
rim_sex_fruit <- update(rim_age_fruit, . ~ . + sex)
rim_ses_fruit <- update(rim_sex_fruit, . ~ . + ses)
rim_inc_fruit <- update(rim_ses_fruit, . ~ . + income)
rim_loc_fruit <- update(rim_inc_fruit, . ~ . + location)
rim_ins_fruit <- update(rim_loc_fruit, . ~ . + insurance)

# Store models in a list
models_fruit <- list(
  "Full Model"     = rimfull_fruit,
  "Age"            = rim_age_fruit,
  "Sex"            = rim_sex_fruit,
  "SES"            = rim_ses_fruit,
  "Income"         = rim_inc_fruit,
  "Location"       = rim_loc_fruit,
  "Insurance"      = rim_ins_fruit
)

# Compare AIC values
aic_fruit <- sapply(models_fruit, AIC)
aic_fruit <- sort(aic_fruit)

# Print sorted AIC values
print(aic_fruit)

# Model summary
summary(rim_ins_fruit)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_fruit))

# Confidence intervals for the fixed effects
#confint(rim_ins_fruit)

# Check multicollinearity with VIF
vif(rim_ins_fruit) # it's low

```

### Protein

```{r}
# Fit the full model (starting model)
# Fit the full model (starting model)
rimfull_prot <- glmer(cariesexp ~ prot + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_prot)

# Add one predictor at a time and compare AIC
rim_age_prot <- update(rimfull_prot, . ~ . + age)
rim_sex_prot <- update(rim_age_prot, . ~ . + sex)
rim_ses_prot <- update(rim_sex_prot, . ~ . + ses)
rim_inc_prot <- update(rim_ses_prot, . ~ . + income)
rim_loc_prot <- update(rim_inc_prot, . ~ . + location)
rim_ins_prot <- update(rim_loc_prot, . ~ . + insurance)

# Store models in a list
models_prot <- list(
  "Full Model"     = rimfull_prot,
  "Age"            = rim_age_prot,
  "Sex"            = rim_sex_prot,
  "SES"            = rim_ses_prot,
  "Income"         = rim_inc_prot,
  "Location"       = rim_loc_prot,
  "Insurance"      = rim_ins_prot
)

# Compare AIC values
aic_prot <- sapply(models_prot, AIC)
aic_prot <- sort(aic_prot)

# Print sorted AIC values
print(aic_prot)

# Model summary
summary(rim_ins_prot)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_prot))

# Confidence intervals for the fixed effects
#confint(rim_ins_prot)

# Check multicollinearity with VIF
vif(rim_ins_prot) # it's low


```

### Dairy 

```{r}
# Fit the full model (starting model)
rimfull_dairy <- glmer(cariesexp ~ dairy + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_dairy)

# Add one predictor at a time and compare AIC
rim_age_dairy <- update(rimfull_dairy, . ~ . + age)
rim_sex_dairy <- update(rim_age_dairy, . ~ . + sex)
rim_ses_dairy <- update(rim_sex_dairy, . ~ . + ses)
rim_inc_dairy <- update(rim_ses_dairy, . ~ . + income)
rim_loc_dairy <- update(rim_inc_dairy, . ~ . + location)
rim_ins_dairy <- update(rim_loc_dairy, . ~ . + insurance)

# Store models in a list
models_dairy <- list(
  "Full Model"     = rimfull_dairy,
  "Age"            = rim_age_dairy,
  "Sex"            = rim_sex_dairy,
  "SES"            = rim_ses_dairy,
  "Income"         = rim_inc_dairy,
  "Location"       = rim_loc_dairy,
  "Insurance"      = rim_ins_dairy
)

# Compare AIC values
aic_dairy <- sapply(models_dairy, AIC)
aic_dairy <- sort(aic_dairy)

# Print sorted AIC values
print(aic_dairy)

# Model summary
summary(rim_ins_dairy)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_dairy))

# Confidence intervals for the fixed effects
#confint(rim_ins_dairy)

# Check multicollinearity with VIF
vif(rim_ins_dairy) # it's low

```

### Fats

```{r}
# Fit the full model (starting model)
rimfull_fats <- glmer(cariesexp ~ fats + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_fats)

# Add one predictor at a time and compare AIC
rim_age_fats <- update(rimfull_fats, . ~ . + age)
rim_sex_fats <- update(rim_age_fats, . ~ . + sex)
rim_ses_fats <- update(rim_sex_fats, . ~ . + ses)
rim_inc_fats <- update(rim_ses_fats, . ~ . + income)
rim_loc_fats <- update(rim_inc_fats, . ~ . + location)
rim_ins_fats <- update(rim_loc_fats, . ~ . + insurance)

# Store models in a list
models_fats <- list(
  "Full Model"     = rimfull_fats,
  "Age"            = rim_age_fats,
  "Sex"            = rim_sex_fats,
  "SES"            = rim_ses_fats,
  "Income"         = rim_inc_fats,
  "Location"       = rim_loc_fats,
  "Insurance"      = rim_ins_fats
)

# Compare AIC values
aic_fats <- sapply(models_fats, AIC)
aic_fats <- sort(aic_fats)

# Print sorted AIC values
print(aic_fats)

# Model summary
summary(rim_ins_fats)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_fats))

# Confidence intervals for the fixed effects
#confint(rim_ins_fats)

# Check multicollinearity with VIF
vif(rim_ins_fats) # it's low

```


### Sugar

```{r}
# Fit the full model (starting model)
rimfull_sugar <- glmer(cariesexp ~ sugar + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_sugar)

# Add one predictor at a time and compare AIC
rim_age_sugar <- update(rimfull_sugar, . ~ . + age)
rim_sex_sugar <- update(rim_age_sugar, . ~ . + sex)
rim_ses_sugar <- update(rim_sex_sugar, . ~ . + ses)
rim_inc_sugar <- update(rim_ses_sugar, . ~ . + income)
rim_loc_sugar <- update(rim_inc_sugar, . ~ . + location)
rim_ins_sugar <- update(rim_loc_sugar, . ~ . + insurance)

# Store models in a list
models_sugar <- list(
  "Full Model"     = rimfull_sugar,
  "Age"            = rim_age_sugar,
  "Sex"            = rim_sex_sugar,
  "SES"            = rim_ses_sugar,
  "Income"         = rim_inc_sugar,
  "Location"       = rim_loc_sugar,
  "Insurance"      = rim_ins_sugar
)

# Compare AIC values
aic_sugar <- sapply(models_sugar, AIC)
aic_sugar <- sort(aic_sugar)

# Print sorted AIC values
print(aic_sugar)

# Model summary
summary(rim_ins_sugar)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_sugar))

# Confidence intervals for the fixed effects
#confint(rim_ins_sugar)

# Check multicollinearity with VIF
vif(rim_ins_sugar) # it's low

```

### Soda

```{r}
# Fit the full model (starting model)
rimfull_soda <- glmer(cariesexp ~ soda + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_soda)

# Add one predictor at a time and compare AIC
rim_age_soda <- update(rimfull_soda, . ~ . + age)
rim_sex_soda <- update(rim_age_soda, . ~ . + sex)
rim_ses_soda <- update(rim_sex_soda, . ~ . + ses)
rim_inc_soda <- update(rim_ses_soda, . ~ . + income)
rim_loc_soda <- update(rim_inc_soda, . ~ . + location)
rim_ins_soda <- update(rim_loc_soda, . ~ . + insurance)

# Store models in a list
models_soda <- list(
  "Full Model"     = rimfull_soda,
  "Age"            = rim_age_soda,
  "Sex"            = rim_sex_soda,
  "SES"            = rim_ses_soda,
  "Income"         = rim_inc_soda,
  "Location"       = rim_loc_soda,
  "Insurance"      = rim_ins_soda
)

# Compare AIC values
aic_soda <- sapply(models_soda, AIC)
aic_soda <- sort(aic_soda)

# Print sorted AIC values
print(aic_soda)

# Model summary
summary(rim_ins_soda)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_soda))

# Confidence intervals for the fixed effects
#confint(rim_ins_soda)

# Check multicollinearity with VIF
vif(rim_ins_soda) # it's low

```

### Juice

```{r}
# Fit the full model (starting model)
rimfull_juice <- glmer(cariesexp ~ juice + (1|Region:Subreg), data = ensab, family = binomial)
summary(rimfull_juice)

# Add one predictor at a time and compare AIC
rim_age_juice <- update(rimfull_juice, . ~ . + age)
rim_sex_juice <- update(rim_age_juice, . ~ . + sex)
rim_ses_juice <- update(rim_sex_juice, . ~ . + ses)
rim_inc_juice <- update(rim_ses_juice, . ~ . + income)
rim_loc_juice <- update(rim_inc_juice, . ~ . + location)
rim_ins_juice <- update(rim_loc_juice, . ~ . + insurance)

# Store models in a list
models_juice <- list(
  "Full Model"     = rimfull_juice,
  "Age"            = rim_age_juice,
  "Sex"            = rim_sex_juice,
  "SES"            = rim_ses_juice,
  "Income"         = rim_inc_juice,
  "Location"       = rim_loc_juice,
  "Insurance"      = rim_ins_juice
)

# Compare AIC values
aic_juice <- sapply(models_juice, AIC)
aic_juice <- sort(aic_juice)

# Print sorted AIC values
print(aic_juice)

# Model summary
summary(rim_ins_juice)

# Exponentiate fixed effects for odds ratios
exp(fixef(rim_ins_juice))

# Confidence intervals for the fixed effects
#confint(rim_ins_juice)

# Check multicollinearity with VIF
vif(rim_ins_juice) # it's low

```


## Logistic regression (no survey design)

### Carbs

Simple logistic regression

```{r}
#logistic regression

library(car) #for VIF
if(!require("rcompanion")) install.packages("rcompanion")
library(rcompanion) #for cramers V

#mcarbs <- svyglm(cariesexp ~ carbs, design = survensab, family = "binomial")
mcarbs_svyno <- glm(cariesexp ~ carbs, data = ensab, family = "binomial")
summary(mcarbs_svyno)

mcarbs2_svyno <- glm(cariesexp ~ carbs + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mcarbs2_svyno)

#checking multicollinearity and correlation between suspected variables

vif(mcarbs2_svyno) #check for multi-collinearity

chisq.test(table(as.numeric(ensab$ses), as.numeric(ensab$income))) #they are associated

cramerV(table(ensab$ses, ensab$income)) #Cramer V of 0.2, weak association

cramerV(table(ensab$ses, ensab$insurance)) #Cramer V of 0.2, weak association

#create a correlation matrix between all the predictors

cor_matrix <- cor(
  sapply(ensab[, c("carbs", "age", "sex", "ses", "income", "insurance", "region", "location")], 
         function(x) as.numeric(as.factor(x))),
  use = "complete.obs", 
  method = "spearman"
)

image(cor_matrix, axes = FALSE, main = "Correlation matrix")
```

Veg

```{r}
mveg_svyno <- glm(cariesexp ~ veg, data = ensab, family = "binomial")
summary(mveg_svyno)

mveg2_svyno <- glm(cariesexp ~ veg + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mveg2_svyno)
exp(mveg2_svyno$coefficients)

```

Fruit

```{r}
mfruit_svyno <- glm(cariesexp ~ fruit, data = ensab, family = "binomial")
summary(mfruit_svyno)

mfruit2_svyno <- glm(cariesexp ~ fruit + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mfruit2_svyno)
exp(mfruit2_svyno$coefficients)
```

Protein

```{r}
mprot_svyno <- glm(cariesexp ~ prot, data = ensab, family = "binomial")
summary(mprot_svyno)

mprot2_svyno <- glm(cariesexp ~ prot + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mprot2_svyno)
exp(mprot2_svyno$coefficients)

```

Dairy

```{r}
mdairy_svyno <- glm(cariesexp ~ dairy, data = ensab, family = "binomial")
summary(mdairy_svyno)

mdairy2_svyno <- glm(cariesexp ~ dairy + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mdairy2_svyno)
exp(mdairy2_svyno$coefficients)
```

Fats

```{r}
mfats_svyno <- glm(cariesexp ~ fats, data = ensab, family = "binomial")
summary(mfats_svyno)

mfats2_svyno <- glm(cariesexp ~ fats + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mfats2_svyno)
exp(mfats2_svyno$coefficients)
```

Sugar

```{r}
msugar_svyno <- glm(cariesexp ~ sugar, data = ensab, family = "binomial")
summary(msugar_svyno)

msugar2_svyno <- glm(cariesexp ~ sugar + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(msugar2_svyno)
exp(msugar2_svyno$coefficients)
```

Soda

```{r}
msoda_svyno <- glm(cariesexp ~ soda, data = ensab, family = "binomial")
summary(msoda_svyno)

msoda2_svyno <- glm(cariesexp ~ soda + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(msoda2_svyno)
exp(msoda2_svyno$coefficients)

```

Juice

```{r}
mjuice_svyno <- glm(cariesexp ~ juice, data = ensab, family = "binomial")
summary(mjuice_svyno)

mjuice2_svyno <- glm(cariesexp ~ juice + age + sex + ses + income + insurance + region + location, data = ensab, family = "binomial")
summary(mjuice2_svyno)
exp(mjuice2_svyno$coefficients)
```


## Exploring the relationship between age of first appointment and caries (dmft)

The hypothesis is that the older the child was at it's first appointment, the higher the dmft index.

ensab %>%
  filter(!is.na(agefdv)) %>%
ggplot(aes(x=agefdv, y=dmft)) +
  geom_boxplot() +
  facet_wrap(~age) +
  labs(x = "Age of first dental visit", y = "dmft Index score", title = "dmft Index score by age of first dental visit")

```{r}
# Boxplot
```

