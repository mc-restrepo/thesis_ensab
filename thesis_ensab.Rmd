---
title: "ENSAB"
author: "Maria Camila Restrepo"
date: "2024-11-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ENSAB databases

```{r}
library(here)
library(readr)
library(tidyverse)

ninoscompleta <- read_delim(
  here("ensab", "M3_NINOS.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

examen13completa <- read_delim(
  here("ensab", "M4_EXAMEN_1.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

examen5completa <- read_delim(
  here("ensab", "M4_EXAMEN_2.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

hogarcompleta <- read_delim(
  here("ensab", "M1_HOGAR.txt"), 
  delim = "|", 
  locale = locale(encoding = "Latin1")
)

```

We have a total of 6446 children for the sample size

```{r}
glimpse(ninoscompleta)
names(ninoscompleta)
```

Keep variables:

- MPIO
- DPTO
- M3_100C: age
- M3_113E: regimen del ppal responsable economico
- M3_113F: maximo nivel educativo alcanzado por el ppal responsable economico
- M3_119: ingresos mensuales ppal responsable economico
- M3_205: ha tenido cita con odontologo
- M3_206A: Edad de primera cita
- M3_206B: Meses o años. 1: meses, 2 años.
- M3_208: Lugar de consulta
- M3_209: Motivo de connsulta
- M3_210: No atencion
- M3_213: Edad de comenzar higiene
- M3_214: Quien hace higiene
- M3_224: Lactancia materna edad
- M3_225: Biberon
- M3_226: Biberon edad
- M3_227: Que le dan en el biberon. 227A-227CU
- Clase: cabecera, cp, rural
- Region: a donde pertenece el municipio
- Subreg:
- Municipio:
- Estrato: Estrato muestral dentro de subregion
- Fex_fin: factor de expansion final
- Sexo
- Zona: urbana, rural
- EST_SE_2: Nivel socioeconomico
- FRACCION: fraccion social
- REGIMEN: contributivo, subsidiado, especial, no asegurado
- ID_HOGAR
- ID_PERSONA

Grupo etareo was excluded because it is the same as age.

Hogar has the same basic variables, so we wont join it for now.

```{r}
ninos <- ninoscompleta %>% 
  select(MPIO, DPTO, M3_100C, M3_113E, M3_113F, M3_119, M3_205, M3_206A, M3_206B, M3_207, M3_208, M3_209, M3_210, M3_213, M3_214, M3_224, M3_225, M3_226, M3_227, M3_227A, M3_227B, M3_227C, M3_227D, M3_227E, M3_227F, M3_227G, M3_227CU, Clase, Region, Subreg, Estrato, Fex_fin, Sexo, Zona, EST_SE_2, FRACCION, REGIMEN, ID_HOGAR, ID_PERSONA)

glimpse(ninos)
```

## Main outcome: dmft index

Caries:

DMFT: decayed, missing and filled teeth

Questions 305 and 307

0: A Sano, F sellante, 
1: B Cavitaded, C: filling with caries, D: filled without caries, E: missing due to caries, G: Protesis, corona, retenedor, carilla
H: no registra (ausente o sin erupcionar)

MA_305A, MA_305B, MA_305C, MA_305D, MA_305E, MA_305F, MA_305G, MA_305H, MA_305I, MA_305J
MA_307A, MA_307B, MA_307C, MA_307D, MA_307E, MA_307F, MA_307G, MA_307H, MA_307I, MA_307J

For permanent teeth: 

0: 0 Sano, 5: missing for another reason, 6: seallant, 8: not erupted, 9: not registered (ausente)
1: 1 cavitated, 2: filling with caries, 3: filled without caries, 4: missing due to caries, 7: Protesis, corona, retenedor, carilla

MB_208: Aplicación del examen clínico (dependiendo de 
antecedentes médicos). 1: se aplica el examen. 2: no se aplica el examen.

### Children 1 and 3 years old

```{r}
examen13 <- examen13completa %>% 
  select(MA_208, MA_305A, MA_305B, MA_305C, MA_305D, MA_305E, MA_305F, MA_305G, MA_305H, MA_305I, MA_305J, MA_307A, MA_307B, MA_307C, MA_307D, MA_307E, MA_307F, MA_307G, MA_307H, MA_307I, MA_307J, ID_HOGAR, ID_PERSONA)

#Assign a value to 1 to the following letters: B, C, D, E, G
examen13 <- examen13 %>%
  mutate(
    across(
      starts_with("MA_3"),
      ~case_when(
        str_detect(., "[BCDEG]") ~ 1,
        TRUE ~ 0)
    ))

#create variable dmft
examen13 <- examen13 %>%
  mutate(dmft = rowSums(across(starts_with("MA_3"), ~. > 0))) %>%
  select(-starts_with("MA_3"))

glimpse(examen13)
summary(examen13$dmft)

#See distribution
ggplot(data = examen13, aes(x = dmft)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score")
```

### Children 5 years old

dmft can take into account the first permanent molar. So the maximum value can be up to 24.

```{r}
examen5 <- examen5completa %>% 
  select(MB_208, MB_305A, MB_305B, MB_305C, MB_305D, MB_305E, MB_305F, MB_305G, MB_305H, MB_305I, MB_305J, MB_305K, MB_305L, MB_307A, MB_307B, MB_307C, MB_307D, MB_307E, MB_307F, MB_307G, MB_307H, MB_307I, MB_307J, MB_307K, MB_307L, ID_HOGAR, ID_PERSONA)

glimpse(examen5)

#Assign a value to 1 to the following numbers: 1, 2, 3, 4, 7
examen5 <- examen5 %>%
  mutate(
    across(
      starts_with("MB_3"),
      ~case_when(
        str_detect(., "^[12347]$|^[BCDEG]$") ~ 1,
        TRUE ~ 0                                 
      )))

#create variable dmft
examen5 <- examen5 %>%
  mutate(dmft = rowSums(across(starts_with("MB_3"), ~. > 0))) %>%
  select(-starts_with("MB_3"))

summary(examen5$dmft)

#See distribution
ggplot(data = examen5, aes(x = dmft)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(x = "dmft Index score", y = "Participants", title = "Distribution of dmft Index score")
```

Merge datasets:

```{r}
ensab <- ninos %>%
  left_join(examen13, by = "ID_PERSONA") %>%
  left_join(examen5, by = "ID_PERSONA") %>%
  mutate(dmft = coalesce(dmft.x, dmft.y)) %>%
  select(-ID_HOGAR.x, -ID_HOGAR.y, -dmft.x, -dmft.y)

#Missing data

ensab %>%
  filter(MA_208 == 2 | MB_208 == 2) %>%
  count()

ensab <- ensab %>%
  filter(MA_208 == 1 | MB_208 == 1) %>%
  select(-MB_208, -MA_208)

#only  3 children did not have the clinical examination portion. We'll exclude them. Now the sample size is 6443 children.
```

# Posible exposures

Age of first dental visit (agefdv). It is composed of:
- M3_206A: numeric
- M3_206B: 1: months, 2: years

Take into account M3_205: have they ever had an appointment with a dentist?  
1: yes, 2: no, 3: doesn't know

Could possibly categorize

```{r}

#Turn M3_206A into a numeric variable
ensab$M3_206A <- as.numeric(ensab$M3_206A)

summary(ensab$M3_206A)

ensab %>%
  filter(M3_205 == 2 | M3_205 == 3) %>%
  count()
#2648: coincides with the number of NAs

ensab %>%
  filter(M3_205 == 3) %>%
  count()
#only 46 participants have missing values for M3_205

#multiply values in the filtered rows by 12 and categorize
ensab <- ensab %>%
  mutate(agefdv = if_else(M3_206B == 2, M3_206A * 12, M3_206A))

ggplot(ensab, aes(x = agefdv)) +
  geom_histogram(fill = "skyblue", color = "black") +
  scale_x_continuous(breaks = seq(min(ensab$agefdv, na.rm = TRUE), max(ensab$agefdv, na.rm = TRUE), by = 6)) +
  labs(x = "Age of first dental visit", y = "Participants", title = "Distribution of age of first dental visit")

# can do bins 0-6, 7-12, 13-24, 25-36, 37-48, 49-72, or just divide into 3.

ensab <- ensab %>%
  mutate(agefdv = case_when(
    M3_205 == 3 ~ NA_real_,
    M3_205 == 2 ~ 0,
    agefdv <= 12 ~ 1,
    agefdv > 12 ~ 2,
    TRUE ~ agefdv)) %>%
  mutate(agefdv = factor(agefdv, 
                         levels = c(0, 1, 2), 
                         labels = c("Never", "0-12", "13+")))

summary(ensab$agefdv)

ensab <- ensab %>%
  select(-M3_206B, -M3_206A)
```

Reason for last consultation (reason)

M3_209: 
1: por una urgencia
2: para un tratamiento
3: por revision/prevencion
4: certificado odontologico

M207 Is important: when was appointment of the child with the dentist?
1: less than a year ago
2: between 1-2 years
3: more than 3 years
4: does not remember (NA)

```{r}
ensab %>%
  filter(M3_207 == 4) %>%
  count()

#45 NAs to be expected in M3_209


```

# has not been able to get appointment

# age of start of dental hygiene

# who does the dental hygiene

# breastfeeding age

# bottle

# Possible confounders or EMM

```{r}
# age
# socioeconomic level
# income
# health regimen
# region
# gender
# rural area (clase)
# health regimen
```

